import { InjectionToken, NgModule } from "@angular/core";
import { ActivatedRoute, Router } from "@angular/router";
import { Code, ConnectError, createPromiseClient } from "@bufbuild/connect";
import { createConnectTransport } from "@bufbuild/connect-web";
import { AuthService, CalendarService, RoleService, SelfServiceService, UserService, RosterService, WorkShiftService, HolidayService, OffTimeService, WorkTimeService, CommentService } from "@tkd/apis";
import { CallService } from '@tkd/apis/gen/es/tkd/pbx3cx/v1/calllog_connect';
import * as i0 from "@angular/core";
export const CONNECT_CONFIG = new InjectionToken('CONNECT_CONFIG');
export const AUTH_SERVICE = new InjectionToken('AUTH_SERVICE');
export const SELF_SERVICE = new InjectionToken('SELF_SERVICE');
export const USER_SERVICE = new InjectionToken('USER_SERVICE');
export const ROLE_SERVICE = new InjectionToken('ROLE_SERVICE');
export const CALENDAR_SERVICE = new InjectionToken('CALENDAR_SERVICE');
export const HOLIDAY_SERVICE = new InjectionToken('HOLIDAY_SERVICE');
export const ROSTER_SERVICE = new InjectionToken('ROSTER_SERVICE');
export const WORK_SHIFT_SERVICE = new InjectionToken('WORK_SHIFT_SERVICE');
export const CALL_SERVICE = new InjectionToken('OVERWRITE_SERVICE');
export const OFFTIME_SERVICE = new InjectionToken('OFFTIME_SERVICE');
export const WORKTIME_SERVICE = new InjectionToken('WORKTIME_SERVICE');
export const COMMENT_SERVICE = new InjectionToken('COMMENT_SERVICE');
function serviceClientFactory(type, ep) {
    return ((route, router, cfg) => {
        let transport = transportFactory(route, router, cfg, ep);
        return createPromiseClient(type, transport);
    });
}
function makeProvider(token, type, ep) {
    return {
        deps: [
            ActivatedRoute,
            Router,
            CONNECT_CONFIG
        ],
        provide: token,
        useFactory: serviceClientFactory(type, ep),
    };
}
export const connectProviders = [
    makeProvider(AUTH_SERVICE, AuthService, "accountService"),
    makeProvider(SELF_SERVICE, SelfServiceService, "accountService"),
    makeProvider(USER_SERVICE, UserService, "accountService"),
    makeProvider(ROLE_SERVICE, RoleService, "accountService"),
    makeProvider(CALENDAR_SERVICE, CalendarService, "calendarService"),
    makeProvider(HOLIDAY_SERVICE, HolidayService, "calendarService"),
    makeProvider(ROSTER_SERVICE, RosterService, "rosterService"),
    makeProvider(WORK_SHIFT_SERVICE, WorkShiftService, "rosterService"),
    makeProvider(CALL_SERVICE, CallService, "callService"),
    makeProvider(OFFTIME_SERVICE, OffTimeService, "rosterService"),
    makeProvider(WORKTIME_SERVICE, WorkTimeService, "rosterService"),
    makeProvider(COMMENT_SERVICE, CommentService, "commentService")
];
const retryRefreshToken = (transport, activatedRoute, router) => {
    let pendingRefresh = null;
    return (next) => async (req) => {
        try {
            const result = await next(req);
            return result;
        }
        catch (err) {
            const connectErr = ConnectError.from(err);
            // don't retry the request if it was a Login or RefreshToken.
            if (req.service.typeName === AuthService.typeName && (req.method.name === 'Login' || req.method.name == 'RefreshToken')) {
                console.log("skipping retry as requested service is " + `${req.service.typeName}/${req.method.name}`);
                throw err;
            }
            if (connectErr.code === Code.Unauthenticated) {
                if (pendingRefresh === null) {
                    let _resolve;
                    let _reject;
                    pendingRefresh = new Promise((resolve, reject) => {
                        _resolve = resolve;
                        _reject = reject;
                    });
                    pendingRefresh
                        .catch(() => { })
                        .then(() => pendingRefresh = null);
                    const cli = createPromiseClient(AuthService, transport);
                    console.log(`[DEBUG] call to ${req.service.typeName}/${req.method.name} not authenticated, trying to refresh token`);
                    try {
                        let redirect = activatedRoute.snapshot.queryParamMap.get("redirect");
                        if (!redirect && router.getCurrentNavigation() !== null) {
                            redirect = router.getCurrentNavigation().extractedUrl.queryParamMap.get("redirect");
                        }
                        const res = await cli.refreshToken({
                            requestedRedirect: redirect || '',
                        });
                        _resolve();
                    }
                    catch (refreshErr) {
                        console.error("failed to refresh token", refreshErr);
                        _reject(err);
                        throw err;
                    }
                }
                else {
                    // wait for the pending refresh to finish
                    try {
                        await pendingRefresh;
                    }
                    catch (_) {
                        throw err;
                    }
                }
                // retry with a new access token.
                return await next(req);
            }
            throw err;
        }
    };
};
export function transportFactory(route, router, cfg, endpoint) {
    const retryTransport = createConnectTransport({ baseUrl: cfg["accountService"], credentials: 'include' });
    return createConnectTransport({
        baseUrl: cfg[endpoint],
        credentials: 'include',
        jsonOptions: {
            ignoreUnknownFields: true
        },
        interceptors: [
            retryRefreshToken(retryTransport, route, router),
        ],
    });
}
class TkdConnectModule {
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TkdConnectModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule }); }
    static { this.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: "14.0.0", version: "16.2.12", ngImport: i0, type: TkdConnectModule }); }
    static { this.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TkdConnectModule, providers: connectProviders }); }
}
export { TkdConnectModule };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TkdConnectModule, decorators: [{
            type: NgModule,
            args: [{
                    providers: connectProviders,
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdF9jbGllbnRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vZGV2L3Byb2plY3RzL2FuZ3VsYXIvY29ubmVjdC9jb25uZWN0X2NsaWVudHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQVksTUFBTSxlQUFlLENBQUM7QUFDbkUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBeUMsbUJBQW1CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuSCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsV0FBVyxFQUFFLGVBQWUsRUFBRSxXQUFXLEVBQUUsa0JBQWtCLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxnQkFBZ0IsRUFBRSxjQUFjLEVBQUUsY0FBYyxFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDek0sT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdEQUFnRCxDQUFDOztBQVU3RSxNQUFNLENBQUMsTUFBTSxjQUFjLEdBQUcsSUFBSSxjQUFjLENBQWdCLGdCQUFnQixDQUFDLENBQUM7QUFFbEYsTUFBTSxDQUFDLE1BQU0sWUFBWSxHQUFHLElBQUksY0FBYyxDQUFvQixjQUFjLENBQUMsQ0FBQztBQUNsRixNQUFNLENBQUMsTUFBTSxZQUFZLEdBQUcsSUFBSSxjQUFjLENBQW9CLGNBQWMsQ0FBQyxDQUFDO0FBQ2xGLE1BQU0sQ0FBQyxNQUFNLFlBQVksR0FBRyxJQUFJLGNBQWMsQ0FBb0IsY0FBYyxDQUFDLENBQUM7QUFDbEYsTUFBTSxDQUFDLE1BQU0sWUFBWSxHQUFHLElBQUksY0FBYyxDQUFvQixjQUFjLENBQUMsQ0FBQztBQUNsRixNQUFNLENBQUMsTUFBTSxnQkFBZ0IsR0FBRyxJ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QUFFLFNBQVMsRUFBQyxDQUFDLENBQUE7SUFFdkcsT0FBTyxzQkFBc0IsQ0FBQztRQUM1QixPQUFPLEVBQUUsR0FBRyxDQUFDLFFBQVEsQ0FBQztRQUN0QixXQUFXLEVBQUUsU0FBUztRQUN0QixXQUFXLEVBQUU7WUFDWCxtQkFBbUIsRUFBRSxJQUFJO1NBQzFCO1FBQ0QsWUFBWSxFQUFFO1lBQ1osaUJBQWlCLENBQUMsY0FBYyxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUM7U0FDakQ7S0FDRixDQUFDLENBQUE7QUFDSixDQUFDO0FBRUQsTUFHYSxnQkFBZ0I7K0dBQWhCLGdCQUFnQjtnSEFBaEIsZ0JBQWdCO2dIQUFoQixnQkFBZ0IsYUFGaEIsZ0JBQWdCOztTQUVoQixnQkFBZ0I7NEZBQWhCLGdCQUFnQjtrQkFINUIsUUFBUTttQkFBQztvQkFDUixTQUFTLEVBQUUsZ0JBQWdCO2lCQUM1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGlvblRva2VuLCBOZ01vZHVsZSwgUHJvdmlkZXIgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUsIFJvdXRlciB9IGZyb20gXCJAYW5ndWxhci9yb3V0ZXJcIjtcbmltcG9ydCB7IENvZGUsIENvbm5lY3RFcnJvciwgSW50ZXJjZXB0b3IsIFByb21pc2VDbGllbnQsIFRyYW5zcG9ydCwgY3JlYXRlUHJvbWlzZUNsaWVudCB9IGZyb20gXCJAYnVmYnVpbGQvY29ubmVjdFwiO1xuaW1wb3J0IHsgY3JlYXRlQ29ubmVjdFRyYW5zcG9ydCB9IGZyb20gXCJAYnVmYnVpbGQvY29ubmVjdC13ZWJcIjtcbmltcG9ydCB7IEF1dGhTZXJ2aWNlLCBDYWxlbmRhclNlcnZpY2UsIFJvbGVTZXJ2aWNlLCBTZWxmU2VydmljZVNlcnZpY2UsIFVzZXJTZXJ2aWNlLCBSb3N0ZXJTZXJ2aWNlLCBXb3JrU2hpZnRTZXJ2aWNlLCBIb2xpZGF5U2VydmljZSwgT2ZmVGltZVNlcnZpY2UsIFdvcmtUaW1lU2VydmljZSwgQ29tbWVudFNlcnZpY2UgfSBmcm9tIFwiQHRrZC9hcGlzXCI7XG5pbXBvcnQgeyBDYWxsU2VydmljZSB9IGZyb20gJ0B0a2QvYXBpcy9nZW4vZXMvdGtkL3BieDNjeC92MS9jYWxsbG9nX2Nvbm5lY3QnO1xuXG5leHBvcnQgaW50ZXJmYWNlIENvbm5lY3RDb25maWcge1xuICBhY2NvdW50U2VydmljZTogc3RyaW5nO1xuICBjYWxlbmRhclNlcnZpY2U6IHN0cmluZztcbiAgcm9zdGVyU2VydmljZTogc3RyaW5nO1xuICBjb21tZW50U2VydmljZTogc3RyaW5nO1xuICBjYWxsU2VydmljZTogc3RyaW5nO1xufVxuXG5leHBvcnQgY29uc3QgQ09OTkVDVF9DT05GSUcgPSBuZXcgSW5qZWN0aW9uVG9rZW48Q29ubmVjdENvbmZpZz4oJ0NPTk5FQ1RfQ09ORklHJyk7XG5cbmV4cG9ydCBjb25zdCBBVVRIX1NFUlZJQ0UgPSBuZXcgSW5qZWN0aW9uVG9rZW48QXV0aFNlcnZpY2VDbGllbnQ+KCdBVVRIX1NFUlZJQ0UnKTtcbmV4cG9ydCBjb25zdCBTRUxGX1NFUlZJQ0UgPSBuZXcgSW5qZWN0aW9uVG9rZW48U2VsZlNlcnZpY2VDbGllbnQ+KCdTRUxGX1NFUlZJQ0UnKTtcbmV4cG9ydCBjb25zdCBVU0VSX1NFUlZJQ0UgPSBuZXcgSW5qZWN0aW9uVG9rZW48VXNlclNlcnZpY2VDbGllbnQ+KCdVU0VSX1NFUlZJQ0UnKTtcbmV4cG9ydCBjb25zdCBST0xFX1NFUlZJQ0UgPSBuZXcgSW5qZWN0aW9uVG9rZW48Um9sZVNlcnZpY2VDbGllbnQ+KCdST0xFX1NFUlZJQ0UnKTtcbmV4cG9ydCBjb25zdCBDQUxFTkRBUl9TRVJWSUNFID0gbmV3IEluamVjdGlvblRva2VuPENhbGVuZGFyU2VydmljZUNsaWVudD4oJ0NBTEVOREFSX1NFUlZJQ0UnKTtcbmV4cG9ydCBjb25zdCBIT0xJREFZX1NFUlZJQ0UgPSBuZXcgSW5qZWN0aW9uVG9rZW48SG9saWRheVNlcnZpY2VDbGllbnQ+KCdIT0xJREFZX1NFUlZJQ0UnKTtcbmV4cG9ydCBjb25zdCBST1NURVJfU0VSVklDRSA9IG5ldyBJbmplY3Rpb25Ub2tlbjxSb3N0ZXJTZXJ2aWNlQ2xpZW50PignUk9TVEVSX1NFUlZJQ0UnKTtcbmV4cG9ydCBjb25zdCBXT1JLX1NISUZUX1NFUlZJQ0UgPSBuZXcgSW5qZWN0aW9uVG9rZW48V29ya1NoaWZ0U2VydmljZUNsaWVudD4oJ1dPUktfU0hJRlRfU0VSVklDRScpO1xuZXhwb3J0IGNvbnN0IENBTExfU0VSVklDRSA9IG5ldyBJbmplY3Rpb25Ub2tlbjxDYWxsU2VydmljZUNsaWVudD4oJ09WRVJXUklURV9TRVJWSUNFJyk7XG5leHBvcnQgY29uc3QgT0ZGVElNRV9TRVJWSUNFID0gbmV3IEluamVjdGlvblRva2VuPE9mZlRpbWVTZXJ2aWNlQ2xpZW50PignT0ZGVElNRV9TRVJWSUNFJyk7XG5leHBvcnQgY29uc3QgV09SS1RJTUVfU0VSVklDRSA9IG5ldyBJbmplY3Rpb25Ub2tlbjxXb3JrVGltZVNlcnZpY2VDbGllbnQ+KCdXT1JLVElNRV9TRVJWSUNFJyk7XG5leHBvcnQgY29uc3QgQ09NTUVOVF9TRVJWSUNFID0gbmV3IEluamVjdGlvblRva2VuPENvbW1lbnRTZXJ2aWNlQ2xpZW50PignQ09NTUVOVF9TRVJWSUNFJyk7XG5cbmV4cG9ydCB0eXBlIEF1dGhTZXJ2aWNlQ2xpZW50ID0gUHJvbWlzZUNsaWVudDx0eXBlb2YgQXV0aFNlcnZpY2U+O1xuZXhwb3J0IHR5cGUgU2VsZlNlcnZpY2VDbGllbnQgPSBQcm9taXNlQ2xpZW50PHR5cGVvZiBTZWxmU2VydmljZVNlcnZpY2U+O1xuZXhwb3J0IHR5cGUgVXNlclNlcnZpY2VDbGllbnQgPSBQcm9taXNlQ2xpZW50PHR5cGVvZiBVc2VyU2VydmljZT47XG5leHBvcnQgdHlwZSBSb2xlU2VydmljZUNsaWVudCA9IFByb21pc2VDbGllbnQ8dHlwZW9mIFJvbGVTZXJ2aWNlPjtcbmV4cG9ydCB0eXBlIENhbGVuZGFyU2VydmljZUNsaWVudCA9IFByb21pc2VDbGllbnQ8dHlwZW9mIENhbGVuZGFyU2VydmljZT47XG5leHBvcnQgdHlwZSBSb3N0ZXJTZXJ2aWNlQ2xpZW50ID0gUHJvbWlzZUNsaWVudDx0eXBlb2YgUm9zdGVyU2VydmljZT47XG5leHBvcnQgdHlwZSBDYWxsU2VydmljZUNsaWVudCA9IFByb21pc2VDbGllbnQ8dHlwZW9mIENhbGxTZXJ2aWNlPjtcbmV4cG9ydCB0eXBlIFdvcmtTaGlmdFNlcnZpY2VDbGllbnQgPSBQcm9taXNlQ2xpZW50PHR5cGVvZiBXb3JrU2hpZnRTZXJ2aWNlPjtcbmV4cG9ydCB0eXBlIEhvbGlkYXlTZXJ2aWNlQ2xpZW50ID0gUHJvbWlzZUNsaWVudDx0eXBlb2YgSG9saWRheVNlcnZpY2U+O1xuZXhwb3J0IHR5cGUgT2ZmVGltZVNlcnZpY2VDbGllbnQgPSBQcm9taXNlQ2xpZW50PHR5cGVvZiBPZmZUaW1lU2VydmljZT47XG5leHBvcnQgdHlwZSBXb3JrVGltZVNlcnZpY2VDbGllbnQgPSBQcm9taXNlQ2xpZW50PHR5cGVvZiBXb3JrVGltZVNlcnZpY2U+O1xuZXhwb3J0IHR5cGUgQ29tbWVudFNlcnZpY2VDbGllbnQgPSBQcm9taXNlQ2xpZW50PHR5cGVvZiBDb21tZW50U2VydmljZT47XG5cbmZ1bmN0aW9uIHNlcnZpY2VDbGllbnRGYWN0b3J5KHR5cGU6IGFueSwgZXA6IGtleW9mIENvbm5lY3RDb25maWcpOiAocm91dGU6IEFjdGl2YXRlZFJvdXRlLCByb3V0ZXI6IFJvdXRlciwgY2ZnOiBDb25uZWN0Q29uZmlnKSA9PiBhbnkge1xuICByZXR1cm4gKChyb3V0ZTogQWN0aXZhdGVkUm91dGUsIHJvdXRlcjogUm91dGVyLCBjZmc6IENvbm5lY3RDb25maWcpID0+IHtcbiAgICBsZXQgdHJhbnNwb3J0ID0gdHJhbnNwb3J0RmFjdG9yeShyb3V0ZSwgcm91dGVyLCBjZmcsIGVwKTtcbiAgICByZXR1cm4gY3JlYXRlUHJvbWlzZUNsaWVudCh0eXBlLCB0cmFuc3BvcnQpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gbWFrZVByb3ZpZGVyKHRva2VuOiBJbmplY3Rpb25Ub2tlbjxhbnk+LCB0eXBlOiBhbnksIGVwOiBrZXlvZiBDb25uZWN0Q29uZmlnKTogUHJvdmlkZXIge1xuICByZXR1cm4ge1xuICAgIGRlcHM6IFtcbiAgICAgIEFjdGl2YXRlZFJvdXRlLFxuICAgICAgUm91dGVyLFxuICAgICAgQ09OTkVDVF9DT05GSUdcbiAgICBdLFxuICAgIHByb3ZpZGU6IHRva2VuLFxuICAgIHVzZUZhY3Rvcnk6IHNlcnZpY2VDbGllbnRGYWN0b3J5KHR5cGUsIGVwKSxcbiAgfVxufVxuXG5leHBvcnQgY29uc3QgY29ubmVjdFByb3ZpZGVyczogUHJvdmlkZXJbXSA9IFtcbiAgbWFrZVByb3ZpZGVyKEFVVEhfU0VSVklDRSwgQXV0aFNlcnZpY2UsIFwiYWNjb3VudFNlcnZpY2VcIikgLFxuICBtYWtlUHJvdmlkZXIoU0VMRl9TRVJWSUNFLCBTZWxmU2VydmljZVNlcnZpY2UsIFwiYWNjb3VudFNlcnZpY2VcIiksXG4gIG1ha2VQcm92aWRlcihVU0VSX1NFUlZJQ0UsIFVzZXJTZXJ2aWNlLCBcImFjY291bnRTZXJ2aWNlXCIpLFxuICBtYWtlUHJvdmlkZXIoUk9MRV9TRVJWSUNFLCBSb2xlU2VydmljZSwgXCJhY2NvdW50U2VydmljZVwiKSxcbiAgbWFrZVByb3ZpZGVyKENBTEVOREFSX1NFUlZJQ0UsIENhbGVuZGFyU2VydmljZSwgXCJjYWxlbmRhclNlcnZpY2VcIiksXG4gIG1ha2VQcm92aWRlcihIT0xJREFZX1NFUlZJQ0UsIEhvbGlkYXlTZXJ2aWNlLCBcImNhbGVuZGFyU2VydmljZVwiKSxcbiAgbWFrZVByb3ZpZGVyKFJPU1RFUl9TRVJWSUNFLCBSb3N0ZXJTZXJ2aWNlLCBcInJvc3RlclNlcnZpY2VcIiksXG4gIG1ha2VQcm92aWRlcihXT1JLX1NISUZUX1NFUlZJQ0UsIFdvcmtTaGlmdFNlcnZpY2UsIFwicm9zdGVyU2VydmljZVwiKSxcbiAgbWFrZVByb3ZpZGVyKENBTExfU0VSVklDRSwgQ2FsbFNlcnZpY2UsIFwiY2FsbFNlcnZpY2VcIiksXG4gIG1ha2VQcm92aWRlcihPRkZUSU1FX1NFUlZJQ0UsIE9mZlRpbWVTZXJ2aWNlLCBcInJvc3RlclNlcnZpY2VcIiksXG4gIG1ha2VQcm92aWRlcihXT1JLVElNRV9TRVJWSUNFLCBXb3JrVGltZVNlcnZpY2UsIFwicm9zdGVyU2VydmljZVwiKSxcbiAgbWFrZVByb3ZpZGVyKENPTU1FTlRfU0VSVklDRSwgQ29tbWVudFNlcnZpY2UsIFwiY29tbWVudFNlcnZpY2VcIilcbl1cblxuY29uc3QgcmV0cnlSZWZyZXNoVG9rZW46ICh0cmFuc3BvcnQ6IFRyYW5zcG9ydCwgYWN0aXZhdGVkUm91dGU6IEFjdGl2YXRlZFJvdXRlLCByb3V0ZXI6IFJvdXRlcikgPT4gSW50ZXJjZXB0b3IgPSAodHJhbnNwb3J0LCBhY3RpdmF0ZWRSb3V0ZSwgcm91dGVyKSA9PiB7XG4gIGxldCBwZW5kaW5nUmVmcmVzaDogUHJvbWlzZTx2b2lkPiB8IG51bGwgPSBudWxsO1xuXG4gIHJldHVybiAobmV4dCkgPT4gYXN5bmMgKHJlcSkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBuZXh0KHJlcSlcbiAgICAgIHJldHVybiByZXN1bHQ7XG5cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGNvbnN0IGNvbm5lY3RFcnIgPSBDb25uZWN0RXJyb3IuZnJvbShlcnIpO1xuXG4gICAgICAvLyBkb24ndCByZXRyeSB0aGUgcmVxdWVzdCBpZiBpdCB3YXMgYSBMb2dpbiBvciBSZWZyZXNoVG9rZW4uXG4gICAgICBpZiAocmVxLnNlcnZpY2UudHlwZU5hbWUgPT09IEF1dGhTZXJ2aWNlLnR5cGVOYW1lICYmIChyZXEubWV0aG9kLm5hbWUgPT09ICdMb2dpbicgfHwgcmVxLm1ldGhvZC5uYW1lID09ICdSZWZyZXNoVG9rZW4nKSkge1xuICAgICAgICBjb25zb2xlLmxvZyhcInNraXBwaW5nIHJldHJ5IGFzIHJlcXVlc3RlZCBzZXJ2aWNlIGlzIFwiICsgYCR7cmVxLnNlcnZpY2UudHlwZU5hbWV9LyR7cmVxLm1ldGhvZC5uYW1lfWApXG5cbiAgICAgICAgdGhyb3cgZXJyXG4gICAgICB9XG5cbiAgICAgIGlmIChjb25uZWN0RXJyLmNvZGUgPT09IENvZGUuVW5hdXRoZW50aWNhdGVkKSB7XG4gICAgICAgIGlmIChwZW5kaW5nUmVmcmVzaCA9PT0gbnVsbCkge1xuICAgICAgICAgIGxldCBfcmVzb2x2ZTogYW55O1xuICAgICAgICAgIGxldCBfcmVqZWN0OiBhbnk7XG4gICAgICAgICAgcGVuZGluZ1JlZnJlc2ggPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBfcmVzb2x2ZSA9IHJlc29sdmU7XG4gICAgICAgICAgICBfcmVqZWN0ID0gcmVqZWN0O1xuICAgICAgICAgIH0pXG5cbiAgICAgICAgICBwZW5kaW5nUmVmcmVzaFxuICAgICAgICAgICAgLmNhdGNoKCgpID0+IHt9KVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4gcGVuZGluZ1JlZnJlc2ggPSBudWxsKVxuXG4gICAgICAgICAgY29uc3QgY2xpID0gY3JlYXRlUHJvbWlzZUNsaWVudChBdXRoU2VydmljZSwgdHJhbnNwb3J0KTtcblxuICAgICAgICAgIGNvbnNvbGUubG9nKGBbREVCVUddIGNhbGwgdG8gJHtyZXEuc2VydmljZS50eXBlTmFtZX0vJHtyZXEubWV0aG9kLm5hbWV9IG5vdCBhdXRoZW50aWNhdGVkLCB0cnlpbmcgdG8gcmVmcmVzaCB0b2tlbmApXG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGxldCByZWRpcmVjdCA9IGFjdGl2YXRlZFJvdXRlLnNuYXBzaG90LnF1ZXJ5UGFyYW1NYXAuZ2V0KFwicmVkaXJlY3RcIik7XG4gICAgICAgICAgICBpZiAoIXJlZGlyZWN0ICYmIHJvdXRlci5nZXRDdXJyZW50TmF2aWdhdGlvbigpICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgIHJlZGlyZWN0ID0gcm91dGVyLmdldEN1cnJlbnROYXZpZ2F0aW9uKCkhLmV4dHJhY3RlZFVybC5xdWVyeVBhcmFtTWFwLmdldChcInJlZGlyZWN0XCIpXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGNsaS5yZWZyZXNoVG9rZW4oe1xuICAgICAgICAgICAgICByZXF1ZXN0ZWRSZWRpcmVjdDogcmVkaXJlY3QgfHwgJycsXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICBfcmVzb2x2ZSgpO1xuICAgICAgICAgIH0gY2F0Y2ggKHJlZnJlc2hFcnIpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJmYWlsZWQgdG8gcmVmcmVzaCB0b2tlblwiLCByZWZyZXNoRXJyKVxuXG4gICAgICAgICAgICBfcmVqZWN0KGVycik7XG5cbiAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gd2FpdCBmb3IgdGhlIHBlbmRpbmcgcmVmcmVzaCB0byBmaW5pc2hcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgYXdhaXQgcGVuZGluZ1JlZnJlc2g7XG4gICAgICAgICAgfSBjYXRjaCAoXykge1xuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHJldHJ5IHdpdGggYSBuZXcgYWNjZXNzIHRva2VuLlxuICAgICAgICByZXR1cm4gYXdhaXQgbmV4dChyZXEpO1xuICAgICAgfVxuXG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0cmFuc3BvcnRGYWN0b3J5KHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSwgcm91dGVyOiBSb3V0ZXIsIGNmZzogQ29ubmVjdENvbmZpZywgZW5kcG9pbnQ6IGtleW9mIENvbm5lY3RDb25maWcpOiBUcmFuc3BvcnQge1xuICBjb25zdCByZXRyeVRyYW5zcG9ydCA9IGNyZWF0ZUNvbm5lY3RUcmFuc3BvcnQoe2Jhc2VVcmw6IGNmZ1tcImFjY291bnRTZXJ2aWNlXCJdLCBjcmVkZW50aWFsczogJ2luY2x1ZGUnfSlcblxuICByZXR1cm4gY3JlYXRlQ29ubmVjdFRyYW5zcG9ydCh7XG4gICAgYmFzZVVybDogY2ZnW2VuZHBvaW50XSxcbiAgICBjcmVkZW50aWFsczogJ2luY2x1ZGUnLFxuICAgIGpzb25PcHRpb25zOiB7XG4gICAgICBpZ25vcmVVbmtub3duRmllbGRzOiB0cnVlXG4gICAgfSxcbiAgICBpbnRlcmNlcHRvcnM6IFtcbiAgICAgIHJldHJ5UmVmcmVzaFRva2VuKHJldHJ5VHJhbnNwb3J0LCByb3V0ZSwgcm91dGVyKSxcbiAgICBdLFxuICB9KVxufVxuXG5ATmdNb2R1bGUoe1xuICBwcm92aWRlcnM6IGNvbm5lY3RQcm92aWRlcnMsXG59KVxuZXhwb3J0IGNsYXNzIFRrZENvbm5lY3RNb2R1bGUge30iXX0=