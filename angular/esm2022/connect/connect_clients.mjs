import { InjectionToken, NgModule } from "@angular/core";
import { ActivatedRoute, Router } from "@angular/router";
import { Code, ConnectError, createPromiseClient } from "@connectrpc/connect";
import { createConnectTransport } from "@connectrpc/connect-web";
import { AuthService, CalendarService, RoleService, SelfServiceService, UserService, RosterService, WorkShiftService, HolidayService, OffTimeService, WorkTimeService, CommentService, CallService, ConstraintService } from "@tkd/apis";
import * as i0 from "@angular/core";
export const CONNECT_CONFIG = new InjectionToken('CONNECT_CONFIG');
export const AUTH_SERVICE = new InjectionToken('AUTH_SERVICE');
export const SELF_SERVICE = new InjectionToken('SELF_SERVICE');
export const USER_SERVICE = new InjectionToken('USER_SERVICE');
export const ROLE_SERVICE = new InjectionToken('ROLE_SERVICE');
export const CALENDAR_SERVICE = new InjectionToken('CALENDAR_SERVICE');
export const HOLIDAY_SERVICE = new InjectionToken('HOLIDAY_SERVICE');
export const ROSTER_SERVICE = new InjectionToken('ROSTER_SERVICE');
export const WORK_SHIFT_SERVICE = new InjectionToken('WORK_SHIFT_SERVICE');
export const CALL_SERVICE = new InjectionToken('OVERWRITE_SERVICE');
export const OFFTIME_SERVICE = new InjectionToken('OFFTIME_SERVICE');
export const WORKTIME_SERVICE = new InjectionToken('WORKTIME_SERVICE');
export const COMMENT_SERVICE = new InjectionToken('COMMENT_SERVICE');
export const CONSTRAINT_SERVICE = new InjectionToken('CONSTRAINT_SERVICE');
function serviceClientFactory(type, ep) {
    return ((route, router, cfg) => {
        let transport = transportFactory(route, router, cfg, ep);
        return createPromiseClient(type, transport);
    });
}
function makeProvider(token, type, ep) {
    return {
        deps: [
            ActivatedRoute,
            Router,
            CONNECT_CONFIG
        ],
        provide: token,
        useFactory: serviceClientFactory(type, ep),
    };
}
export const connectProviders = [
    makeProvider(AUTH_SERVICE, AuthService, "accountService"),
    makeProvider(SELF_SERVICE, SelfServiceService, "accountService"),
    makeProvider(USER_SERVICE, UserService, "accountService"),
    makeProvider(ROLE_SERVICE, RoleService, "accountService"),
    makeProvider(CALENDAR_SERVICE, CalendarService, "calendarService"),
    makeProvider(HOLIDAY_SERVICE, HolidayService, "calendarService"),
    makeProvider(ROSTER_SERVICE, RosterService, "rosterService"),
    makeProvider(WORK_SHIFT_SERVICE, WorkShiftService, "rosterService"),
    makeProvider(CALL_SERVICE, CallService, "callService"),
    makeProvider(OFFTIME_SERVICE, OffTimeService, "rosterService"),
    makeProvider(WORKTIME_SERVICE, WorkTimeService, "rosterService"),
    makeProvider(CONSTRAINT_SERVICE, ConstraintService, "rosterService"),
    makeProvider(COMMENT_SERVICE, CommentService, "commentService")
];
const retryRefreshToken = (transport, activatedRoute, router) => {
    let pendingRefresh = null;
    return (next) => async (req) => {
        try {
            const result = await next(req);
            return result;
        }
        catch (err) {
            const connectErr = ConnectError.from(err);
            // don't retry the request if it was a Login or RefreshToken.
            if (req.service.typeName === AuthService.typeName && (req.method.name === 'Login' || req.method.name == 'RefreshToken')) {
                console.log("skipping retry as requested service is " + `${req.service.typeName}/${req.method.name}`);
                throw err;
            }
            if (connectErr.code === Code.Unauthenticated) {
                if (pendingRefresh === null) {
                    let _resolve;
                    let _reject;
                    pendingRefresh = new Promise((resolve, reject) => {
                        _resolve = resolve;
                        _reject = reject;
                    });
                    pendingRefresh
                        .catch(() => { })
                        .then(() => pendingRefresh = null);
                    const cli = createPromiseClient(AuthService, transport);
                    console.log(`[DEBUG] call to ${req.service.typeName}/${req.method.name} not authenticated, trying to refresh token`);
                    try {
                        let redirect = activatedRoute.snapshot.queryParamMap.get("redirect");
                        if (!redirect && router.getCurrentNavigation() !== null) {
                            redirect = router.getCurrentNavigation().extractedUrl.queryParamMap.get("redirect");
                        }
                        const res = await cli.refreshToken({
                            requestedRedirect: redirect || '',
                        });
                        _resolve();
                    }
                    catch (refreshErr) {
                        console.error("failed to refresh token", refreshErr);
                        _reject(err);
                        throw err;
                    }
                }
                else {
                    // wait for the pending refresh to finish
                    try {
                        await pendingRefresh;
                    }
                    catch (_) {
                        throw err;
                    }
                }
                // retry with a new access token.
                return await next(req);
            }
            throw err;
        }
    };
};
export function transportFactory(route, router, cfg, endpoint) {
    const retryTransport = createConnectTransport({ baseUrl: cfg["accountService"], credentials: 'include' });
    return createConnectTransport({
        baseUrl: cfg[endpoint],
        credentials: 'include',
        jsonOptions: {
            ignoreUnknownFields: true
        },
        interceptors: [
            retryRefreshToken(retryTransport, route, router),
        ],
    });
}
class TkdConnectModule {
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TkdConnectModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule }); }
    static { this.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: "14.0.0", version: "16.2.12", ngImport: i0, type: TkdConnectModule }); }
    static { this.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TkdConnectModule, providers: connectProviders }); }
}
export { TkdConnectModule };
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: TkdConnectModule, decorators: [{
            type: NgModule,
            args: [{
                    providers: connectProviders,
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdF9jbGllbnRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vZGV2L2NvbXBvbmVudHMvY29ubmVjdC9jb25uZWN0X2NsaWVudHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFVLGNBQWMsRUFBRSxRQUFRLEVBQVksTUFBTSxlQUFlLENBQUM7QUFDM0UsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsSUFBSSxFQUFFLFlBQVksRUFBeUMsbUJBQW1CLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNySCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNqRSxPQUFPLEVBQUUsV0FBVyxFQUFFLGVBQWUsRUFBRSxXQUFXLEVBQUUsa0JBQWtCLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxnQkFBZ0IsRUFBRSxjQUFjLEVBQUUsY0FBYyxFQUFFLGVBQWUsRUFBRSxjQUFjLEVBQUUsV0FBVyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sV0FBVyxDQUFDOztBQWN6TyxNQUFNLENBQUMsTUFBTSxjQUFjLEdBQUcsSUFBSSxjQUFjLENBQWdCLGdCQUFnQixDQUFDLENBQUM7QUFFbEYsTUFBTSxDQUFDLE1BQU0sWUFBWSxHQUFHLElBQUksY0FBYyxDQUFvQixjQUFjLENBQUMsQ0FBQztBQUNsRixNQUFNLENBQUMsTUFBTSxZQUFZLEdBQUcsSUFBSSxjQUFjLENBQW9CLGNBQWMsQ0FBQyxDQUFDO0FBQ2xGLE1BQU0sQ0FBQyxNQUFNLFlBQVksR0FBRyxJQUFJLGNBQWMsQ0FBb0IsY0FBYyxDQUFDLENBQUM7QUFDbEYsTUFBTSxDQUFDLE1BQU0sWUFBWSxHQUFHLElBQUksY0FBYyxDQUFvQixjQUFjLENBQUMsQ0FBQztBQUNsRixNQUFNLENBQUMsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLGNBQWMsQ0FBd0Isa0JBQWtCLENBQUMs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QUUsUUFBNkI7SUFDdkgsTUFBTSxjQUFjLEdBQUcsc0JBQXNCLENBQUMsRUFBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBQyxDQUFDLENBQUE7SUFFdkcsT0FBTyxzQkFBc0IsQ0FBQztRQUM1QixPQUFPLEVBQUUsR0FBRyxDQUFDLFFBQVEsQ0FBQztRQUN0QixXQUFXLEVBQUUsU0FBUztRQUN0QixXQUFXLEVBQUU7WUFDWCxtQkFBbUIsRUFBRSxJQUFJO1NBQzFCO1FBQ0QsWUFBWSxFQUFFO1lBQ1osaUJBQWlCLENBQUMsY0FBYyxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUM7U0FDakQ7S0FDRixDQUFDLENBQUE7QUFDSixDQUFDO0FBRUQsTUFHYSxnQkFBZ0I7K0dBQWhCLGdCQUFnQjtnSEFBaEIsZ0JBQWdCO2dIQUFoQixnQkFBZ0IsYUFGaEIsZ0JBQWdCOztTQUVoQixnQkFBZ0I7NEZBQWhCLGdCQUFnQjtrQkFINUIsUUFBUTttQkFBQztvQkFDUixTQUFTLEVBQUUsZ0JBQWdCO2lCQUM1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0aW9uVG9rZW4sIE5nTW9kdWxlLCBQcm92aWRlciB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSwgUm91dGVyIH0gZnJvbSBcIkBhbmd1bGFyL3JvdXRlclwiO1xuaW1wb3J0IHsgQ29kZSwgQ29ubmVjdEVycm9yLCBJbnRlcmNlcHRvciwgUHJvbWlzZUNsaWVudCwgVHJhbnNwb3J0LCBjcmVhdGVQcm9taXNlQ2xpZW50IH0gZnJvbSBcIkBjb25uZWN0cnBjL2Nvbm5lY3RcIjtcbmltcG9ydCB7IGNyZWF0ZUNvbm5lY3RUcmFuc3BvcnQgfSBmcm9tIFwiQGNvbm5lY3RycGMvY29ubmVjdC13ZWJcIjtcbmltcG9ydCB7IEF1dGhTZXJ2aWNlLCBDYWxlbmRhclNlcnZpY2UsIFJvbGVTZXJ2aWNlLCBTZWxmU2VydmljZVNlcnZpY2UsIFVzZXJTZXJ2aWNlLCBSb3N0ZXJTZXJ2aWNlLCBXb3JrU2hpZnRTZXJ2aWNlLCBIb2xpZGF5U2VydmljZSwgT2ZmVGltZVNlcnZpY2UsIFdvcmtUaW1lU2VydmljZSwgQ29tbWVudFNlcnZpY2UsIENhbGxTZXJ2aWNlLCBDb25zdHJhaW50U2VydmljZSB9IGZyb20gXCJAdGtkL2FwaXNcIjtcblxuLy8gQW55Rm4gaXMgbm90IGV4cG9yZXRlZCBieSBAY29ubmVjdHJwYy9jb25uZWN0XG50eXBlIEFueUZuID0gSW50ZXJjZXB0b3IgZXh0ZW5kcyAoKG5leHQ6IGluZmVyIFQpID0+IGluZmVyIFQpID8gVCA6IG5ldmVyO1xuXG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29ubmVjdENvbmZpZyB7XG4gIGFjY291bnRTZXJ2aWNlOiBzdHJpbmc7XG4gIGNhbGVuZGFyU2VydmljZTogc3RyaW5nO1xuICByb3N0ZXJTZXJ2aWNlOiBzdHJpbmc7XG4gIGNvbW1lbnRTZXJ2aWNlOiBzdHJpbmc7XG4gIGNhbGxTZXJ2aWNlOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjb25zdCBDT05ORUNUX0NPTkZJRyA9IG5ldyBJbmplY3Rpb25Ub2tlbjxDb25uZWN0Q29uZmlnPignQ09OTkVDVF9DT05GSUcnKTtcblxuZXhwb3J0IGNvbnN0IEFVVEhfU0VSVklDRSA9IG5ldyBJbmplY3Rpb25Ub2tlbjxBdXRoU2VydmljZUNsaWVudD4oJ0FVVEhfU0VSVklDRScpO1xuZXhwb3J0IGNvbnN0IFNFTEZfU0VSVklDRSA9IG5ldyBJbmplY3Rpb25Ub2tlbjxTZWxmU2VydmljZUNsaWVudD4oJ1NFTEZfU0VSVklDRScpO1xuZXhwb3J0IGNvbnN0IFVTRVJfU0VSVklDRSA9IG5ldyBJbmplY3Rpb25Ub2tlbjxVc2VyU2VydmljZUNsaWVudD4oJ1VTRVJfU0VSVklDRScpO1xuZXhwb3J0IGNvbnN0IFJPTEVfU0VSVklDRSA9IG5ldyBJbmplY3Rpb25Ub2tlbjxSb2xlU2VydmljZUNsaWVudD4oJ1JPTEVfU0VSVklDRScpO1xuZXhwb3J0IGNvbnN0IENBTEVOREFSX1NFUlZJQ0UgPSBuZXcgSW5qZWN0aW9uVG9rZW48Q2FsZW5kYXJTZXJ2aWNlQ2xpZW50PignQ0FMRU5EQVJfU0VSVklDRScpO1xuZXhwb3J0IGNvbnN0IEhPTElEQVlfU0VSVklDRSA9IG5ldyBJbmplY3Rpb25Ub2tlbjxIb2xpZGF5U2VydmljZUNsaWVudD4oJ0hPTElEQVlfU0VSVklDRScpO1xuZXhwb3J0IGNvbnN0IFJPU1RFUl9TRVJWSUNFID0gbmV3IEluamVjdGlvblRva2VuPFJvc3RlclNlcnZpY2VDbGllbnQ+KCdST1NURVJfU0VSVklDRScpO1xuZXhwb3J0IGNvbnN0IFdPUktfU0hJRlRfU0VSVklDRSA9IG5ldyBJbmplY3Rpb25Ub2tlbjxXb3JrU2hpZnRTZXJ2aWNlQ2xpZW50PignV09SS19TSElGVF9TRVJWSUNFJyk7XG5leHBvcnQgY29uc3QgQ0FMTF9TRVJWSUNFID0gbmV3IEluamVjdGlvblRva2VuPENhbGxTZXJ2aWNlQ2xpZW50PignT1ZFUldSSVRFX1NFUlZJQ0UnKTtcbmV4cG9ydCBjb25zdCBPRkZUSU1FX1NFUlZJQ0UgPSBuZXcgSW5qZWN0aW9uVG9rZW48T2ZmVGltZVNlcnZpY2VDbGllbnQ+KCdPRkZUSU1FX1NFUlZJQ0UnKTtcbmV4cG9ydCBjb25zdCBXT1JLVElNRV9TRVJWSUNFID0gbmV3IEluamVjdGlvblRva2VuPFdvcmtUaW1lU2VydmljZUNsaWVudD4oJ1dPUktUSU1FX1NFUlZJQ0UnKTtcbmV4cG9ydCBjb25zdCBDT01NRU5UX1NFUlZJQ0UgPSBuZXcgSW5qZWN0aW9uVG9rZW48Q29tbWVudFNlcnZpY2VDbGllbnQ+KCdDT01NRU5UX1NFUlZJQ0UnKTtcbmV4cG9ydCBjb25zdCBDT05TVFJBSU5UX1NFUlZJQ0UgPSBuZXcgSW5qZWN0aW9uVG9rZW48Q29uc3RyYWludFNlcnZpY2VDbGllbnQ+KCdDT05TVFJBSU5UX1NFUlZJQ0UnKTtcblxuZXhwb3J0IHR5cGUgQXV0aFNlcnZpY2VDbGllbnQgPSBQcm9taXNlQ2xpZW50PHR5cGVvZiBBdXRoU2VydmljZT47XG5leHBvcnQgdHlwZSBTZWxmU2VydmljZUNsaWVudCA9IFByb21pc2VDbGllbnQ8dHlwZW9mIFNlbGZTZXJ2aWNlU2VydmljZT47XG5leHBvcnQgdHlwZSBVc2VyU2VydmljZUNsaWVudCA9IFByb21pc2VDbGllbnQ8dHlwZW9mIFVzZXJTZXJ2aWNlPjtcbmV4cG9ydCB0eXBlIFJvbGVTZXJ2aWNlQ2xpZW50ID0gUHJvbWlzZUNsaWVudDx0eXBlb2YgUm9sZVNlcnZpY2U+O1xuZXhwb3J0IHR5cGUgQ2FsZW5kYXJTZXJ2aWNlQ2xpZW50ID0gUHJvbWlzZUNsaWVudDx0eXBlb2YgQ2FsZW5kYXJTZXJ2aWNlPjtcbmV4cG9ydCB0eXBlIFJvc3RlclNlcnZpY2VDbGllbnQgPSBQcm9taXNlQ2xpZW50PHR5cGVvZiBSb3N0ZXJTZXJ2aWNlPjtcbmV4cG9ydCB0eXBlIENhbGxTZXJ2aWNlQ2xpZW50ID0gUHJvbWlzZUNsaWVudDx0eXBlb2YgQ2FsbFNlcnZpY2U+O1xuZXhwb3J0IHR5cGUgV29ya1NoaWZ0U2VydmljZUNsaWVudCA9IFByb21pc2VDbGllbnQ8dHlwZW9mIFdvcmtTaGlmdFNlcnZpY2U+O1xuZXhwb3J0IHR5cGUgSG9saWRheVNlcnZpY2VDbGllbnQgPSBQcm9taXNlQ2xpZW50PHR5cGVvZiBIb2xpZGF5U2VydmljZT47XG5leHBvcnQgdHlwZSBPZmZUaW1lU2VydmljZUNsaWVudCA9IFByb21pc2VDbGllbnQ8dHlwZW9mIE9mZlRpbWVTZXJ2aWNlPjtcbmV4cG9ydCB0eXBlIFdvcmtUaW1lU2VydmljZUNsaWVudCA9IFByb21pc2VDbGllbnQ8dHlwZW9mIFdvcmtUaW1lU2VydmljZT47XG5leHBvcnQgdHlwZSBDb21tZW50U2VydmljZUNsaWVudCA9IFByb21pc2VDbGllbnQ8dHlwZW9mIENvbW1lbnRTZXJ2aWNlPjtcbmV4cG9ydCB0eXBlIENvbnN0cmFpbnRTZXJ2aWNlQ2xpZW50ID0gUHJvbWlzZUNsaWVudDx0eXBlb2YgQ29uc3RyYWludFNlcnZpY2U+O1xuXG5mdW5jdGlvbiBzZXJ2aWNlQ2xpZW50RmFjdG9yeSh0eXBlOiBhbnksIGVwOiBrZXlvZiBDb25uZWN0Q29uZmlnKTogKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSwgcm91dGVyOiBSb3V0ZXIsIGNmZzogQ29ubmVjdENvbmZpZykgPT4gYW55IHtcbiAgcmV0dXJuICgocm91dGU6IEFjdGl2YXRlZFJvdXRlLCByb3V0ZXI6IFJvdXRlciwgY2ZnOiBDb25uZWN0Q29uZmlnKSA9PiB7XG4gICAgbGV0IHRyYW5zcG9ydCA9IHRyYW5zcG9ydEZhY3Rvcnkocm91dGUsIHJvdXRlciwgY2ZnLCBlcCk7XG4gICAgcmV0dXJuIGNyZWF0ZVByb21pc2VDbGllbnQodHlwZSwgdHJhbnNwb3J0KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIG1ha2VQcm92aWRlcih0b2tlbjogSW5qZWN0aW9uVG9rZW48YW55PiwgdHlwZTogYW55LCBlcDoga2V5b2YgQ29ubmVjdENvbmZpZyk6IFByb3ZpZGVyIHtcbiAgcmV0dXJuIHtcbiAgICBkZXBzOiBbXG4gICAgICBBY3RpdmF0ZWRSb3V0ZSxcbiAgICAgIFJvdXRlcixcbiAgICAgIENPTk5FQ1RfQ09ORklHXG4gICAgXSxcbiAgICBwcm92aWRlOiB0b2tlbixcbiAgICB1c2VGYWN0b3J5OiBzZXJ2aWNlQ2xpZW50RmFjdG9yeSh0eXBlLCBlcCksXG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IGNvbm5lY3RQcm92aWRlcnM6IFByb3ZpZGVyW10gPSBbXG4gIG1ha2VQcm92aWRlcihBVVRIX1NFUlZJQ0UsIEF1dGhTZXJ2aWNlLCBcImFjY291bnRTZXJ2aWNlXCIpICxcbiAgbWFrZVByb3ZpZGVyKFNFTEZfU0VSVklDRSwgU2VsZlNlcnZpY2VTZXJ2aWNlLCBcImFjY291bnRTZXJ2aWNlXCIpLFxuICBtYWtlUHJvdmlkZXIoVVNFUl9TRVJWSUNFLCBVc2VyU2VydmljZSwgXCJhY2NvdW50U2VydmljZVwiKSxcbiAgbWFrZVByb3ZpZGVyKFJPTEVfU0VSVklDRSwgUm9sZVNlcnZpY2UsIFwiYWNjb3VudFNlcnZpY2VcIiksXG4gIG1ha2VQcm92aWRlcihDQUxFTkRBUl9TRVJWSUNFLCBDYWxlbmRhclNlcnZpY2UsIFwiY2FsZW5kYXJTZXJ2aWNlXCIpLFxuICBtYWtlUHJvdmlkZXIoSE9MSURBWV9TRVJWSUNFLCBIb2xpZGF5U2VydmljZSwgXCJjYWxlbmRhclNlcnZpY2VcIiksXG4gIG1ha2VQcm92aWRlcihST1NURVJfU0VSVklDRSwgUm9zdGVyU2VydmljZSwgXCJyb3N0ZXJTZXJ2aWNlXCIpLFxuICBtYWtlUHJvdmlkZXIoV09SS19TSElGVF9TRVJWSUNFLCBXb3JrU2hpZnRTZXJ2aWNlLCBcInJvc3RlclNlcnZpY2VcIiksXG4gIG1ha2VQcm92aWRlcihDQUxMX1NFUlZJQ0UsIENhbGxTZXJ2aWNlLCBcImNhbGxTZXJ2aWNlXCIpLFxuICBtYWtlUHJvdmlkZXIoT0ZGVElNRV9TRVJWSUNFLCBPZmZUaW1lU2VydmljZSwgXCJyb3N0ZXJTZXJ2aWNlXCIpLFxuICBtYWtlUHJvdmlkZXIoV09SS1RJTUVfU0VSVklDRSwgV29ya1RpbWVTZXJ2aWNlLCBcInJvc3RlclNlcnZpY2VcIiksXG4gIG1ha2VQcm92aWRlcihDT05TVFJBSU5UX1NFUlZJQ0UsIENvbnN0cmFpbnRTZXJ2aWNlLCBcInJvc3RlclNlcnZpY2VcIiksXG4gIG1ha2VQcm92aWRlcihDT01NRU5UX1NFUlZJQ0UsIENvbW1lbnRTZXJ2aWNlLCBcImNvbW1lbnRTZXJ2aWNlXCIpXG5dXG5cbmNvbnN0IHJldHJ5UmVmcmVzaFRva2VuOiAodHJhbnNwb3J0OiBUcmFuc3BvcnQsIGFjdGl2YXRlZFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSwgcm91dGVyOiBSb3V0ZXIpID0+IEludGVyY2VwdG9yID0gKHRyYW5zcG9ydCwgYWN0aXZhdGVkUm91dGUsIHJvdXRlcikgPT4ge1xuICBsZXQgcGVuZGluZ1JlZnJlc2g6IFByb21pc2U8dm9pZD4gfCBudWxsID0gbnVsbDtcblxuICByZXR1cm4gKG5leHQ6IEFueUZuKSA9PiBhc3luYyAocmVxKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG5leHQocmVxKVxuICAgICAgcmV0dXJuIHJlc3VsdDtcblxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc3QgY29ubmVjdEVyciA9IENvbm5lY3RFcnJvci5mcm9tKGVycik7XG5cbiAgICAgIC8vIGRvbid0IHJldHJ5IHRoZSByZXF1ZXN0IGlmIGl0IHdhcyBhIExvZ2luIG9yIFJlZnJlc2hUb2tlbi5cbiAgICAgIGlmIChyZXEuc2VydmljZS50eXBlTmFtZSA9PT0gQXV0aFNlcnZpY2UudHlwZU5hbWUgJiYgKHJlcS5tZXRob2QubmFtZSA9PT0gJ0xvZ2luJyB8fCByZXEubWV0aG9kLm5hbWUgPT0gJ1JlZnJlc2hUb2tlbicpKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwic2tpcHBpbmcgcmV0cnkgYXMgcmVxdWVzdGVkIHNlcnZpY2UgaXMgXCIgKyBgJHtyZXEuc2VydmljZS50eXBlTmFtZX0vJHtyZXEubWV0aG9kLm5hbWV9YClcblxuICAgICAgICB0aHJvdyBlcnJcbiAgICAgIH1cblxuICAgICAgaWYgKGNvbm5lY3RFcnIuY29kZSA9PT0gQ29kZS5VbmF1dGhlbnRpY2F0ZWQpIHtcbiAgICAgICAgaWYgKHBlbmRpbmdSZWZyZXNoID09PSBudWxsKSB7XG4gICAgICAgICAgbGV0IF9yZXNvbHZlOiBhbnk7XG4gICAgICAgICAgbGV0IF9yZWplY3Q6IGFueTtcbiAgICAgICAgICBwZW5kaW5nUmVmcmVzaCA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIF9yZXNvbHZlID0gcmVzb2x2ZTtcbiAgICAgICAgICAgIF9yZWplY3QgPSByZWplY3Q7XG4gICAgICAgICAgfSlcblxuICAgICAgICAgIHBlbmRpbmdSZWZyZXNoXG4gICAgICAgICAgICAuY2F0Y2goKCkgPT4ge30pXG4gICAgICAgICAgICAudGhlbigoKSA9PiBwZW5kaW5nUmVmcmVzaCA9IG51bGwpXG5cbiAgICAgICAgICBjb25zdCBjbGkgPSBjcmVhdGVQcm9taXNlQ2xpZW50KEF1dGhTZXJ2aWNlLCB0cmFuc3BvcnQpO1xuXG4gICAgICAgICAgY29uc29sZS5sb2coYFtERUJVR10gY2FsbCB0byAke3JlcS5zZXJ2aWNlLnR5cGVOYW1lfS8ke3JlcS5tZXRob2QubmFtZX0gbm90IGF1dGhlbnRpY2F0ZWQsIHRyeWluZyB0byByZWZyZXNoIHRva2VuYClcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgbGV0IHJlZGlyZWN0ID0gYWN0aXZhdGVkUm91dGUuc25hcHNob3QucXVlcnlQYXJhbU1hcC5nZXQoXCJyZWRpcmVjdFwiKTtcbiAgICAgICAgICAgIGlmICghcmVkaXJlY3QgJiYgcm91dGVyLmdldEN1cnJlbnROYXZpZ2F0aW9uKCkgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgcmVkaXJlY3QgPSByb3V0ZXIuZ2V0Q3VycmVudE5hdmlnYXRpb24oKSEuZXh0cmFjdGVkVXJsLnF1ZXJ5UGFyYW1NYXAuZ2V0KFwicmVkaXJlY3RcIilcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgY2xpLnJlZnJlc2hUb2tlbih7XG4gICAgICAgICAgICAgIHJlcXVlc3RlZFJlZGlyZWN0OiByZWRpcmVjdCB8fCAnJyxcbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIF9yZXNvbHZlKCk7XG4gICAgICAgICAgfSBjYXRjaCAocmVmcmVzaEVycikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcImZhaWxlZCB0byByZWZyZXNoIHRva2VuXCIsIHJlZnJlc2hFcnIpXG5cbiAgICAgICAgICAgIF9yZWplY3QoZXJyKTtcblxuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyB3YWl0IGZvciB0aGUgcGVuZGluZyByZWZyZXNoIHRvIGZpbmlzaFxuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBwZW5kaW5nUmVmcmVzaDtcbiAgICAgICAgICB9IGNhdGNoIChfKSB7XG4gICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gcmV0cnkgd2l0aCBhIG5ldyBhY2Nlc3MgdG9rZW4uXG4gICAgICAgIHJldHVybiBhd2FpdCBuZXh0KHJlcSk7XG4gICAgICB9XG5cbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRyYW5zcG9ydEZhY3Rvcnkocm91dGU6IEFjdGl2YXRlZFJvdXRlLCByb3V0ZXI6IFJvdXRlciwgY2ZnOiBDb25uZWN0Q29uZmlnLCBlbmRwb2ludDoga2V5b2YgQ29ubmVjdENvbmZpZyk6IFRyYW5zcG9ydCB7XG4gIGNvbnN0IHJldHJ5VHJhbnNwb3J0ID0gY3JlYXRlQ29ubmVjdFRyYW5zcG9ydCh7YmFzZVVybDogY2ZnW1wiYWNjb3VudFNlcnZpY2VcIl0sIGNyZWRlbnRpYWxzOiAnaW5jbHVkZSd9KVxuXG4gIHJldHVybiBjcmVhdGVDb25uZWN0VHJhbnNwb3J0KHtcbiAgICBiYXNlVXJsOiBjZmdbZW5kcG9pbnRdLFxuICAgIGNyZWRlbnRpYWxzOiAnaW5jbHVkZScsXG4gICAganNvbk9wdGlvbnM6IHtcbiAgICAgIGlnbm9yZVVua25vd25GaWVsZHM6IHRydWVcbiAgICB9LFxuICAgIGludGVyY2VwdG9yczogW1xuICAgICAgcmV0cnlSZWZyZXNoVG9rZW4ocmV0cnlUcmFuc3BvcnQsIHJvdXRlLCByb3V0ZXIpLFxuICAgIF0sXG4gIH0pXG59XG5cbkBOZ01vZHVsZSh7XG4gIHByb3ZpZGVyczogY29ubmVjdFByb3ZpZGVycyxcbn0pXG5leHBvcnQgY2xhc3MgVGtkQ29ubmVjdE1vZHVsZSB7fSJdfQ==